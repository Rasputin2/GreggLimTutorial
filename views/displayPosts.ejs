<!DOCTYPE html>
<html lang="en">

  <%- include('layouts/header');-%>

<body>

  <%- include('layouts/navbar');-%>

  <!-- Page Header --> 
  <header class="masthead" style="background-image: url('/assets/img/about-bg.jpg')">
    <div class="container position-relative px-4 px-lg-5">
      <div class="row gx-4 gx-lg-5 justify-content-center">
          <div class="col-md-10 col-lg-8 col-xl-7">
              <div class="page-heading">
                  <h1>Scroll Left or Right</h1>
                  <span class="subheading">Upvote or Downvote Question. View Answers.</span>
              </div>
          </div>
      </div>
    </div>
  </header>
  
  <!-- Moved jquery import up here on purpose. -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Begin Main Class-->
  <main class="mb-4">
    <div class="container px-4 px-lg-5">
      <div class="row gx-4 gx-lg-5 justify-content-center">
        <div class="col-md-10 col-lg-8 col-xl-7">
            <!-- Carousel -->
            <!-- data-bs-ride="carousel" excluded -->
            <div id="demo" class="carousel slide"  data-bs-interval="false">     
              <!-- The slideshow/carousel -->
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <div class="row" id = "message-body">
                    <% if (questions.length > 0) { %>
                    <h2 style="text-align: center">Use Left and Right Arrows </h2>
                    <h2 style="text-align: center">to Scroll</h2>
                    <h2 style="text-align: center">Through Questions</h2>
                    <% } else { %>
                      <h2 style="text-align: center">No Results</h2>
                      <h2 style="text-align: center">Post Your Own Question</h2>
                    <% } %>  
                  </div>
                </div>
                <%   
                var max = questions.length
                for (var i = 0; i < max; i++) {
                %>
              <div class="carousel-item" style="text-align: justify" >
                <div class="row" id = "message-body">
                  <h2><%= questions[i].title %></h2>
                  <p><%= questions[i].body %></p>
                </div>
                <div class="row" id="parent-node">
                  <p><strong>Posted by: </strong><%= questions[i].userid.username %> on <%= questions[i].datePosted.toDateString() %> </p>
                  <p id="score"><strong>Relevance: </strong><%= questions[i].upvotes %></p>
                  <p hidden id="questionID" type="number"><%= questions[i]._id %></p>
                </div>
              </div>
              <% } %>          
            <!-- Left and right controls/icons -->  
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#demo" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" id="prevIcon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#demo" data-bs-slide="next">
            <span class="carousel-control-next-icon" id="nextIcon"></span>
            </button>
            <!-- Blank Row -->
            <div class="row gx-4 gx-lg-5 justify-content-center"></div>
            <!-- Upvote and Downvote Buttons -->
            <div class="row gx-4 gx-lg-5 justify-content-center">
              <div class="text-center" style="width: 100%; white-space: nowrap;"> 
                <button style = "display: inline-block; width: 20%; border:2px solid black; border-radius: 10px; background-color: none; margin-left:10px" id="minus"><i class="fas fa-thumbs-down"></i></button>                
                <button style = "display: inline-block; width: 20%; border-radius: 10px; border:2px solid black; background-color: none; margin-right:10px" id="plus"><i class="fas fa-thumbs-up"></i></button>
                <form action="/display/answers" method="POST">
                  <p></p>
                  <button id="submitButton" name="questionID" value="0" style = "border-radius: 8px; margin-left: 10px; margin-right: 10px; background-color:darkcyan; width: 50%; border:2px solid black; margin-bottom:15px" type="submit">View Answers</button>
                </form>
              </div>
            </div>              
          </div>              
        </div>
      </div>
    </div>
  </main>  
    
  <script>
    $(document).ready(function(){
    
      /*
      * Keep Track of the Carousel Index Position
      * and Relevant DOM Elements
      */
      var index = 0;
      const parent_nodes = document.querySelectorAll("#questionID");
      const num_parent_nodes = parent_nodes.length;
      const score_nodes = document.querySelectorAll("#score");

      console.log(index)
      console.log(num_parent_nodes)

      $("#prevIcon").click(function() {

          if (index == 0) {
            index = num_parent_nodes; 
          } else {  
            index--;
          }
          console.log("INDEX: " + index)

      });

      $("#nextIcon").click(function() {

        if (index == num_parent_nodes) {
          index = 0;
        } else {
          index++;
        }

        console.log("INDEX: " + index)

      });
      
      // Handle Upvote
      $("#plus").click(function(){
        console.log("Inside Plus when index is: " + index);

        if (index != 0) {
          var postid = parent_nodes.item(index-1).innerHTML
          var stringPostID = JSON.stringify(postid).replace("ID: ", "").trim();
          stringPostID = stringPostID.replace('"', '');
          stringPostID = stringPostID.replace('"', '');
          console.log("stringPostID: " + stringPostID);

          $.ajax({
            type: "post",
            url: "/vote",
            datatype: "json",
            data: {"questionID" : stringPostID, "action" : "upvoteQuestion"},
            success: function(result) {
              console.log("Result: " + JSON.stringify(result))
              console.log("result.revisedScore: " + result.revisedScore);
              score_nodes.item(index-1).innerHTML = "<strong>Relevance: </strong>" + result.revisedScore;
              alert("Your upvote has been recorded!");
            }
          })
        }
      });
  
      // Handle Downvote
      $("#minus").click(function(event){
        console.log("Inside Minus when index is: " + index);

        if (index != 0) {
          var postid = parent_nodes.item(index-1).innerHTML
          var stringPostID = JSON.stringify(postid).replace("ID: ", "").trim();
          stringPostID = stringPostID.replace('"', '')
          stringPostID = stringPostID.replace('"', '')
          console.log("This is Stringify PostID: " + stringPostID)
          
          $.ajax({
            type: "post",
            url: "/vote",
            datatype: "json",
            data: {"questionID" : stringPostID, "action" : "downvoteQuestion"},
            success: function(result) {
              console.log("Result: " + JSON.stringify(result))
              score_nodes.item(index-1).innerHTML = "<strong>Relevance: </strong>" + result.revisedScore;
              alert("Your downvote has been recorded!");
            },
            error: function(xhr, status, error) {
              var err = eval("(" + xhr.responseText + ")");
              alert(err.Message);
            }
          })
        }
      });

      document.getElementById('submitButton').onclick = function() {
        if (index != 0) {
          var postid = parent_nodes.item(index-1).innerHTML
          var stringPostID = JSON.stringify(postid).replace("ID: ", "").trim();
          stringPostID = stringPostID.replace('"', '')
          stringPostID = stringPostID.replace('"', '')
          this.value = stringPostID;
        }
      }

    });    
  </script>

  <%- include('layouts/footer');-%>

  <%- include('layouts/scripts');-%>

</body>

</html>
